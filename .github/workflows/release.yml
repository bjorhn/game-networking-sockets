name: Build and Release GNS

on:
  push:
    branches: [master]
  workflow_dispatch:

concurrency:
  group: release
  cancel-in-progress: false

env:
  # Upstream GNS commit to build. Last tagged release (v1.4.1, June 2022) is incompatible
  # with protobuf 5.x, so we track master instead. Update this hash to pull in new changes.
  GNS_COMMIT: 517fff0cf6866ba163f4f016b0ef28f365c06c05

jobs:
  build-windows:
    name: Build Windows x64
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    # No checkout needed - this job builds from the upstream source tarball, not this repo.
    steps:
      - uses: ilammy/msvc-dev-cmd@0b201ec74fa43914dc39ae48a89fd1d8cb592756 # v1.13.0

      - name: Install vcpkg dependencies
        run: |
          Add-Content "$env:VCPKG_INSTALLATION_ROOT\triplets\x64-windows.cmake" "`nset(VCPKG_BUILD_TYPE release)`nset(VCPKG_LIBRARY_LINKAGE static)"
          & "$env:VCPKG_INSTALLATION_ROOT\vcpkg" install protobuf:x64-windows openssl:x64-windows

      - name: Download and extract GNS source
        run: |
          curl -L -o gns-src.tar.gz https://github.com/ValveSoftware/GameNetworkingSockets/archive/${{ env.GNS_COMMIT }}.tar.gz
          tar -xzf gns-src.tar.gz
          Get-Item GameNetworkingSockets-* | Rename-Item -NewName gns-src

      - name: Configure CMake
        run: |
          cmake -S gns-src -B gns-src/build -G Ninja `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake" `
            -DVCPKG_TARGET_TRIPLET=x64-windows `
            -DCMAKE_RUNTIME_OUTPUT_DIRECTORY=bin `
            -DCMAKE_ARCHIVE_OUTPUT_DIRECTORY=bin `
            -DBUILD_SHARED_LIB=ON `
            -DBUILD_STATIC_LIB=OFF `
            -DBUILD_EXAMPLES=OFF `
            -DBUILD_TESTS=OFF `
            -DBUILD_TOOLS=OFF `
            -DUSE_CRYPTO=OpenSSL `
            -DProtobuf_USE_STATIC_LIBS=ON

      - name: Build
        run: ninja -C gns-src/build

      - name: Stage Windows artifacts
        run: |
          mkdir artifacts
          cp gns-src/build/bin/GameNetworkingSockets.dll artifacts/
          cp gns-src/build/src/bin/GameNetworkingSockets.lib artifacts/

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7.0.0
        with:
          name: gns-windows-x64
          path: artifacts/
          if-no-files-found: error

  build-linux:
    name: Build Linux x64
    runs-on: ubuntu-latest
    # No checkout needed - this job builds from the upstream source tarball, not this repo.
    steps:
      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build

      - name: Install vcpkg dependencies
        run: |
          echo 'set(VCPKG_BUILD_TYPE release)' >> "$VCPKG_INSTALLATION_ROOT/triplets/x64-linux.cmake"
          "$VCPKG_INSTALLATION_ROOT/vcpkg" install protobuf:x64-linux openssl:x64-linux

      - name: Download and extract GNS source
        run: |
          curl -L -o gns-src.tar.gz https://github.com/ValveSoftware/GameNetworkingSockets/archive/${{ env.GNS_COMMIT }}.tar.gz
          tar -xzf gns-src.tar.gz
          mv GameNetworkingSockets-* gns-src

      - name: Configure CMake
        run: |
          cmake -S gns-src -B gns-src/build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE="$VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake" \
            -DVCPKG_TARGET_TRIPLET=x64-linux \
            -DCMAKE_LIBRARY_OUTPUT_DIRECTORY=bin \
            -DBUILD_SHARED_LIB=ON \
            -DBUILD_STATIC_LIB=OFF \
            -DBUILD_EXAMPLES=OFF \
            -DBUILD_TESTS=OFF \
            -DBUILD_TOOLS=OFF \
            -DUSE_CRYPTO=OpenSSL \
            -DProtobuf_USE_STATIC_LIBS=ON

      - name: Build
        run: ninja -C gns-src/build

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7.0.0
        with:
          name: gns-linux-x64
          path: gns-src/build/bin/libGameNetworkingSockets.so*
          if-no-files-found: error

  release:
    name: Package and Release
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Download Windows artifacts
        uses: actions/download-artifact@70fc10c6e5e1ce46ad2ea6f2b72d43f7d47b13c3 # v8.0.0
        with:
          name: gns-windows-x64
          path: artifacts/windows

      - name: Download Linux artifacts
        uses: actions/download-artifact@70fc10c6e5e1ce46ad2ea6f2b72d43f7d47b13c3 # v8.0.0
        with:
          name: gns-linux-x64
          path: artifacts/linux

      - name: Download GNS source for headers and license
        run: |
          curl -L -o gns-src.tar.gz https://github.com/ValveSoftware/GameNetworkingSockets/archive/${{ env.GNS_COMMIT }}.tar.gz
          tar -xzf gns-src.tar.gz
          mv GameNetworkingSockets-* gns-src

      - name: Assemble package
        run: |
          mkdir -p gns/include/steam
          mkdir -p gns/lib/windows-x64
          mkdir -p gns/lib/linux-x64

          # Copy all headers
          cp gns-src/include/steam/*.h gns/include/steam/

          # Copy Windows binaries
          cp artifacts/windows/GameNetworkingSockets.dll gns/lib/windows-x64/
          cp artifacts/windows/GameNetworkingSockets.lib gns/lib/windows-x64/

          # Copy Linux binary
          cp artifacts/linux/libGameNetworkingSockets.so* gns/lib/linux-x64/

          # Include license from GNS source
          cp gns-src/LICENSE gns/LICENSE

          # Verify contents
          echo "=== Package contents ==="
          find gns -type f | sort

          # Create zip
          zip -r gns.zip gns/

      - name: Update latest release
        run: |
          gh release delete latest --yes --cleanup-tag --repo ${{ github.repository }} || true
          gh release create latest gns.zip --repo ${{ github.repository }} \
            --title "Latest Build" \
            --notes "Pre-built GameNetworkingSockets (commit ${{ env.GNS_COMMIT }}) binaries for Windows x64 and Linux x64."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
